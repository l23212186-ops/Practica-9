<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes y Médicos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="navbar"></div>

    <main class="main-container">

        <div id="public-content" class="welcome-box">
            <h1>Bienvenido al Portal de Gestión</h1>
            <p style="color: #666; font-size: 1.1rem;">Plataforma integral para el control de expedientes médicos.</p>
            
            <img src="/Carrera.jpeg" alt="Imagen de bienvenida" class="welcome-img">
            
            <div style="margin-top: 30px;">
                <p>Por favor, inicia sesión para acceder al sistema.</p>
                <a href="/login.html" class="login-button">Ir a Iniciar Sesión</a>
            </div>
        </div>

        <div id="medico-content" style="display:none;">
            <h1 style="text-align: left; border-bottom: 2px solid #0ec2c8; padding-bottom: 10px;">Panel Médico</h1>
            
            <div class="dashboard-grid">
                
                <section class="card">
                    <h2>Registrar Paciente</h2>
                    <form action="/submit-data" method="POST">
                        <label for="name">Nombre del paciente:</label>
                        <input type="text" id="name" name="name" placeholder="Ej: Juan Pérez" required>
                        
                        <label for="age">Edad:</label>
                        <input type="number" id="age" name="age" placeholder="Ej: 30" required>

                        <label for="heart-rate">Frecuencia Cardiaca (bpm):</label>
                        <input type="number" id="heart-rate" name="heart_rate" placeholder="Ej: 80" required>

                        <button type="submit">Guardar Paciente</button>
                    </form>
                    <button class="btn-secondary" onclick="window.location.href='/pacientes'">Ver Lista Completa</button>
                </section>

                <section class="card">
                    <h2>Búsqueda Avanzada</h2>
                    <form action="/buscar-pacientes" method="GET">
                        <label for="name-search">Nombre:</label>
                        <input type="text" id="name-search" name="name_search" placeholder="Escribe para buscar en vivo...">
                        
                        <label for="age-search">Edad (Opcional):</label>
                        <input type="number" id="age-search" name="age_search">
                        
                        <button type="submit">Buscar</button>
                    </form>
                    
                    <div id="live-search-results"></div>

                    <div style="margin-top: 20px;">
                        <button class="btn-secondary" onclick="window.location.href='/ordenar-pacientes'">Ordenar por Frecuencia C.</button>
                    </div>
                </section>

                <section class="card full-width">
                    <h2>Gestión por Lotes (Excel)</h2>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: space-around; align-items: flex-start;">
                        
                        <div style="flex: 1; min-width: 300px;">
                            <h3>Importar</h3>
                            <p style="font-size: 0.9rem; color: #666;">Sube un archivo .xlsx con columnas: <strong>nombre, edad, frecuencia_cardiaca</strong>.</p>
                            <form action="/upload-pacientes" method="POST" enctype="multipart/form-data" style="border: 1px dashed #ccc; padding: 15px; border-radius: 8px;">
                                <label for="excel-file">Seleccionar archivo:</label>
                                <input type="file" id="excel-file" name="archivoExcel" accept=".xlsx" required style="border: none;">
                                <button type="submit">Subir e Importar</button>
                            </form>
                        </div>

                        <div style="flex: 1; min-width: 300px; text-align: center; padding-top: 20px;">
                            <h3>Exportar</h3>
                            <p style="font-size: 0.9rem; color: #666;">Genera un reporte completo.</p>
                            <button onclick="window.location.href='/download-pacientes'" style="max-width: 250px;">Descargar Reporte Excel</button>
                        </div>
                    </div>
                </section>

            </div> </div>

        <div id="admin-content" style="display:none; margin-top: 40px;">
            <section class="card full-width" style="border-top: 4px solid #10156c;">
                <h2>Panel de Administrador</h2>
                
                <div style="display: flex; flex-wrap: wrap; gap: 30px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Registrar Nuevo Médico</h3>
                        <form action="/insertar-medico" method="POST">
                            <label for="medico-name">Nombre del médico:</label>
                            <input type="text" id="medico-name" name="medico_name" required>

                            <label for="especialidad">Especialidad:</label>
                            <input type="text" id="especialidad" name="especialidad" required>

                            <button type="submit">Guardar Médico</button>
                        </form>
                    </div>

                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                        <button onclick="window.location.href='/medicos'" class="btn-secondary">Ver Médicos Registrados</button>
                    </div>
                </div>
            </section>
        </div>

    </main>

    <script>
        fetch('/navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data; 
                return fetch('/tipo-usuario'); 
            })
            .then(response => {
                if (!response.ok) { throw new Error('No autenticado'); }
                return response.json();
            })
            .then(data => {
                // Oculta el contenido público
                const publicContent = document.getElementById('public-content');
                if(publicContent) publicContent.style.display = 'none';

                const menu = document.getElementById('menu');
                const tipoUsuario = data.tipo_usuario;

                // --- LÓGICA DE ROLES ---
                if (tipoUsuario === 'admin') {
                    document.getElementById('medico-content').style.display = 'block';
                    document.getElementById('admin-content').style.display = 'block';
                    if(menu) {
                        menu.innerHTML += '<li><a href="/ver-usuarios">Ver Usuarios</a></li>';
                        menu.innerHTML += '<li><a href="/gestionar-registros">Gestionar Registros</a></li>';
                    }
                    setupLiveSearch();
                    
                } else if (tipoUsuario === 'medico') {
                    document.getElementById('medico-content').style.display = 'block';
                    if(menu) {
                        menu.innerHTML += '<li><a href="/pacientes">Ver Pacientes</a></li>'; 
                        menu.innerHTML += '<li><a href="/editar-pacientes">Editar Pacientes</a></li>';
                    }
                    setupLiveSearch();
                
                } else if (tipoUsuario === 'paciente') {
                    if(menu) menu.innerHTML += '<li><a href="/ver-mis-datos">Mis Datos</a></li>';
                }
                
                if(menu) menu.innerHTML += '<li><a href="/logout">Cerrar Sesión</a></li>';

                // --- FUNCIÓN DE BÚSQUEDA EN VIVO (MODIFICADA) ---
                function setupLiveSearch() {
                    const searchInput = document.getElementById('name-search');
                    const resultsContainer = document.getElementById('live-search-results');

                    if (!searchInput) return;

                    searchInput.addEventListener('keyup', function() {
                        const term = this.value;

                        // MODIFICACIÓN AQUÍ:
                        // Antes era: if (term.length < 2)
                        // Ahora es: if (term.length === 0)
                        // Esto permite buscar desde la primera letra.
                        if (term.length === 0) { 
                            resultsContainer.innerHTML = '';
                            return;
                        }

                        fetch(`/buscar-pacientes-live?term=${term}`)
                            .then(res => res.json())
                            .then(data => {
                                resultsContainer.innerHTML = ''; 
                                
                                if (data.length === 0) {
                                    resultsContainer.innerHTML = '<p style="padding:10px; color:#666;">No se encontraron coincidencias.</p>';
                                    return;
                                }

                                let html = '<ul>';
                                data.forEach(paciente => {
                                    html += `<li><strong>${paciente.nombre}</strong> <br> <span style="font-size:0.85em; color:#555;">Edad: ${paciente.edad} | FC: ${paciente.frecuencia_cardiaca}</span></li>`;
                                });
                                html += '</ul>';
                                resultsContainer.innerHTML = html;
                            })
                            .catch(err => {
                                console.error('Error en fetch de búsqueda:', err);
                                resultsContainer.innerHTML = '<p style="color:red;">Error al buscar.</p>';
                            });
                    });
                }
            })
            .catch(error => {
                console.log('Usuario no logueado o error:', error);
                setTimeout(() => {
                    const menu = document.getElementById('menu');
                    if (menu) {
                        menu.innerHTML += '<li><a href="/login.html">Iniciar Sesión</a></li>';
                    }
                }, 100);
            });
    </script>

</body>
</html>